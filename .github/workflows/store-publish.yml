name: Store Publish

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true
        type: string
      source_ref:
        description: 'Optional pinned git ref (tag/SHA/refs/*). Empty = tip of resolved release branch'
        required: false
        type: string

permissions:
  contents: read

env:
  SOLUTION_FILE: ClipSave.slnx
  APP_PROJECT: src/ClipSave/ClipSave.csproj

jobs:
  build-store-package:
    runs-on: windows-latest

    steps:
    - name: Resolve release branch
      id: release
      shell: pwsh
      run: |
        $version = "${{ inputs.version }}"
        if ($version -notmatch '^(?<major>\d+)\.(?<minor>\d+)\.(?<patch>\d+)$') {
          Write-Error "Invalid version format: $version (expected X.Y.Z)"
          exit 1
        }
        $branch = "release/$($matches['major']).$($matches['minor'])"
        echo "BRANCH=$branch" >> $env:GITHUB_OUTPUT
        echo "Resolved branch: $branch"

    - name: Resolve checkout ref
      id: checkout
      shell: pwsh
      run: |
        $sourceRef = "${{ inputs.source_ref }}".Trim()
        $defaultRef = "${{ steps.release.outputs.BRANCH }}"
        $checkoutRef = if ([string]::IsNullOrWhiteSpace($sourceRef)) { $defaultRef } else { $sourceRef }
        $isPinned = if ([string]::IsNullOrWhiteSpace($sourceRef)) { "false" } else { "true" }

        echo "REF=$checkoutRef" >> $env:GITHUB_OUTPUT
        echo "PINNED=$isPinned" >> $env:GITHUB_OUTPUT
        echo "Resolved checkout ref: $checkoutRef"
        echo "Pinned mode: $isPinned"

    - name: Verify branch exists
      shell: pwsh
      run: |
        $branch = "${{ steps.release.outputs.BRANCH }}"
        $encodedBranch = [Uri]::EscapeDataString($branch)
        $result = gh api "repos/${{ github.repository }}/branches/$encodedBranch" 2>$null
        if (-not $result) {
          Write-Error "Branch '$branch' does not exist. Create a release branch first."
          exit 1
        }
        echo "âœ… Branch verified: $branch"
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.checkout.outputs.REF }}
        fetch-depth: 0

    - name: Validate pinned source ref is in target release branch
      if: ${{ steps.checkout.outputs.PINNED == 'true' }}
      shell: pwsh
      run: |
        $branch = "${{ steps.release.outputs.BRANCH }}"
        $ref = "${{ steps.checkout.outputs.REF }}"

        git fetch --no-tags origin "$branch"
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Failed to fetch origin/$branch for ancestry verification."
          exit 1
        }

        git merge-base --is-ancestor HEAD "origin/$branch"
        $mergeBaseExit = $LASTEXITCODE
        if ($mergeBaseExit -eq 1) {
          Write-Error "Pinned ref '$ref' is not contained in origin/$branch"
          exit 1
        }
        if ($mergeBaseExit -ne 0) {
          Write-Error "Failed to verify whether pinned ref '$ref' is contained in origin/$branch"
          exit 1
        }

        $head = (git rev-parse HEAD).Trim()
        $branchHead = (git rev-parse "origin/$branch").Trim()
        echo "Pinned ref verified: $ref -> $head (ancestor of origin/$branch @ $branchHead)"

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        global-json-file: global.json

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.slnx') }}
        restore-keys: ${{ runner.os }}-nuget-

    - name: Verify version
      shell: pwsh
      run: |
        [xml]$props = Get-Content Directory.Build.props
        $version = $props.Project.PropertyGroup.Version
        if ($version -ne "${{ inputs.version }}") {
          Write-Error "Version mismatch: Directory.Build.props has $version but input is ${{ inputs.version }}"
          exit 1
        }
        ./scripts/assert-version-policy.ps1 -BranchName "${{ steps.release.outputs.BRANCH }}"
        echo "âœ… Version verified: $version"

    - name: Resolve package version
      id: package
      shell: pwsh
      run: |
        $msixVersion = "${{ inputs.version }}.0"
        echo "MSIX_VERSION=$msixVersion" >> $env:GITHUB_OUTPUT
        echo "MSIX version: $msixVersion"

    - name: Resolve store build versions
      id: version
      shell: pwsh
      run: |
        $version = "${{ inputs.version }}"
        $match = [regex]::Match($version, '^(?<major>\d+)\.(?<minor>\d+)\.(?<patch>\d+)$')
        if (-not $match.Success) {
          Write-Error "Invalid version format: $version (expected X.Y.Z)"
          exit 1
        }

        $coreVersion = "$($match.Groups['major'].Value).$($match.Groups['minor'].Value).$($match.Groups['patch'].Value)"
        $commitSha = (git rev-parse HEAD).Trim()
        if (-not $commitSha -or $commitSha.Length -ne 40) {
          Write-Error "Failed to resolve commit SHA from checked-out source."
          exit 1
        }
        $shortSha = (git rev-parse --short=7 HEAD).Trim()
        if (-not $shortSha -or $shortSha.Length -ne 7) {
          Write-Error "Failed to resolve short SHA from checked-out commit."
          exit 1
        }
        $assemblyVersion = "$($match.Groups['major'].Value).$($match.Groups['minor'].Value).0.0"
        $fileVersion = "$coreVersion.0"
        $informationalVersion = "$coreVersion+sha.$shortSha"

        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "ASSEMBLY_VERSION=$assemblyVersion" >> $env:GITHUB_OUTPUT
        echo "FILE_VERSION=$fileVersion" >> $env:GITHUB_OUTPUT
        echo "INFORMATIONAL_VERSION=$informationalVersion" >> $env:GITHUB_OUTPUT
        echo "COMMIT_SHA=$commitSha" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
        echo "AssemblyVersion: $assemblyVersion"
        echo "FileVersion: $fileVersion"
        echo "InformationalVersion: $informationalVersion"

    - name: Restore
      run: dotnet restore ${{ env.SOLUTION_FILE }}

    - name: Security checks
      shell: pwsh
      run: ./scripts/run-security-checks.ps1 -Configuration Release -NoRestore

    - name: Build app
      shell: pwsh
      run: |
        dotnet build ${{ env.APP_PROJECT }} --configuration Release --no-restore `
          /p:Version="${{ steps.version.outputs.VERSION }}" `
          /p:AssemblyVersion="${{ steps.version.outputs.ASSEMBLY_VERSION }}" `
          /p:FileVersion="${{ steps.version.outputs.FILE_VERSION }}" `
          /p:InformationalVersion="${{ steps.version.outputs.INFORMATIONAL_VERSION }}"

    - name: Test
      shell: pwsh
      run: ./scripts/run-tests.ps1 -Configuration Release -Verbosity normal

    # Desktop Bridge packaging restores/publishes the app as win-x86 internally.
    # Keep this even when package platform is AnyCPU, otherwise NETSDK1047 occurs.
    - name: Restore app assets for MSIX runtime
      run: dotnet restore ${{ env.APP_PROJECT }} --runtime win-x86

    - name: Set MSIX manifest version
      shell: pwsh
      run: |
        $manifestPath = "src/ClipSave.Package/Package.appxmanifest"
        [xml]$manifest = Get-Content $manifestPath
        $ns = New-Object System.Xml.XmlNamespaceManager($manifest.NameTable)
        $ns.AddNamespace("appx", "http://schemas.microsoft.com/appx/manifest/foundation/windows10")
        $identity = $manifest.SelectSingleNode("/appx:Package/appx:Identity", $ns)
        if (-not $identity) {
          throw "Identity node not found in $manifestPath"
        }
        $identity.SetAttribute("Version", "${{ steps.package.outputs.MSIX_VERSION }}")
        $manifest.Save($manifestPath)
        Write-Host "Updated Package.appxmanifest version to ${{ steps.package.outputs.MSIX_VERSION }}"

    - name: Build Store Package
      shell: pwsh
      run: |
        Write-Host "Building Store upload package..." -ForegroundColor Cyan
        msbuild src/ClipSave.Package/ClipSave.Package.wapproj `
          /p:Configuration=Release `
          /p:Platform=AnyCPU `
          /p:Version="${{ steps.version.outputs.VERSION }}" `
          /p:AssemblyVersion="${{ steps.version.outputs.ASSEMBLY_VERSION }}" `
          /p:FileVersion="${{ steps.version.outputs.FILE_VERSION }}" `
          /p:InformationalVersion="${{ steps.version.outputs.INFORMATIONAL_VERSION }}" `
          /p:UapAppxPackageBuildMode=StoreUpload `
          /p:AppxBundle=Always `
          /p:AppxPackageDir="${{ github.workspace }}/StorePackage/" `
          /p:AppxPackageVersion=${{ steps.package.outputs.MSIX_VERSION }} `
          /p:AppxBundleManifestVersion=${{ steps.package.outputs.MSIX_VERSION }} `
          /p:AppxManifestIdentityVersion=${{ steps.package.outputs.MSIX_VERSION }} `
          /p:AppxPackageSigningEnabled=false

    - name: Upload Store Package
      uses: actions/upload-artifact@v4
      with:
        name: store-package-${{ inputs.version }}
        path: StorePackage/**/*.msixupload
        retention-days: 30

    - name: Summary
      shell: pwsh
      run: |
        @"
        ## âœ… Store Package Built Successfully

        | Item | Value |
        |------|-------|
        | **Version** | ``${{ inputs.version }}`` |
        | **Branch** | ``${{ steps.release.outputs.BRANCH }}`` |
        | **Checkout Ref** | ``${{ steps.checkout.outputs.REF }}`` |
        | **Commit SHA** | ``${{ steps.version.outputs.COMMIT_SHA }}`` |
        | **InformationalVersion** | ``${{ steps.version.outputs.INFORMATIONAL_VERSION }}`` |
        | **Package** | ``.msixupload`` |

        ### ðŸ“¥ Next Steps

        1. Download artifact from **Actions** â†’ **Artifacts**
        2. Login to [Partner Center](https://partner.microsoft.com/dashboard)
        3. Create new submission
        4. Upload ``.msixupload`` file
        5. Update metadata and release notes
        6. Submit for certification

        ### âœ… Pre-submission Checklist

        - [ ] Release package artifact (`release-package-${{ inputs.version }}`, unsigned) reviewed (24+ hours)
        - [ ] No critical bugs reported
        - [ ] App description updated (JP/EN)
        - [ ] Screenshots current
        - [ ] Release notes prepared
        - [ ] Age rating verified
        "@ >> $env:GITHUB_STEP_SUMMARY
