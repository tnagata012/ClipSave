# 仕様

**このドキュメントの目的**: ClipSave の詳細仕様を定義します。Integration/UI の仕様検証テストはこのドキュメントの SPEC-ID を基準にします。

## 概要

このドキュメントは [製品コンセプト](../ProductConcept.md) で定義された機能要件を詳細化し、検証可能な仕様として記述します。

## ID と粒度

- SPEC-ID は `SPEC-<カテゴリ3桁>-<連番3桁>` の形式とする（例: `SPEC-000-001`）。
- 1 行 = 1 トリガー / 1 結果を原則とし、複数の結果がある場合は分割する。
- 条件や設定依存の挙動は「条件 → 結果」が判別できるように明記する。
- 仕様の統合・削除時は欠番を残さず、カテゴリ内の連番を振り直す。

## 仕様一覧

### 基本動作 (000)

| ID | 仕様 |
|----|------|
| SPEC-000-001 | 起動直後はウィンドウを表示しない |
| SPEC-000-002 | アクティブウィンドウがデスクトップの場合、ホットキー押下でデスクトップに保存する |
| SPEC-000-003 | アクティブウィンドウがエクスプローラーの場合、ホットキー押下でそのフォルダに保存する |
| SPEC-000-004 | 上記以外のウィンドウがアクティブの場合、ホットキー押下では保存しない（`SPEC-050-006`） |
| SPEC-000-005 | クリップボードに保存可能なコンテンツがない場合、ホットキー押下でエラーにしない |
| SPEC-000-006 | 多重起動試行時、新規インスタンスは終了する |
| SPEC-000-007 | 多重起動試行時、既存インスタンスの設定画面を表示する |
| SPEC-000-008 | アクティブなエクスプローラーが仮想フォルダ（This PC / ごみ箱 等）の場合、ホットキー押下では保存しない（`SPEC-050-006`） |

### 保存機能 - 共通 (010)

| ID | 仕様 |
|----|------|
| SPEC-010-001 | 保存先フォルダ未存在時は自動作成する |
| SPEC-010-002 | ファイル名重複時は `SPEC-017-008` の命名規則に従って連番を付与する |
| SPEC-010-003 | 保存ファイル名はファイル名設定（プレフィックス、タイムスタンプ）を基準に生成する |

### 保存機能 - 画像 (011)

| ID | 仕様 |
|----|------|
| SPEC-011-001 | PNG 形式で正しく保存する |
| SPEC-011-002 | JPG 形式で正しく保存する |
| SPEC-011-003 | 透過画像を JPG 保存する場合、白色背景で合成する |

### 保存機能 - テキスト (012)

| ID | 仕様 |
|----|------|
| SPEC-012-001 | プレーンテキストを .txt として UTF-8 (BOMなし) で保存する |
| SPEC-012-002 | 空白のみのテキストは保存対象外とする |

### 保存機能 - Markdown (013)

| ID | 仕様 |
|----|------|
| SPEC-013-001 | Markdown 形式のテキストを .md として UTF-8 (BOMなし) で保存する |
| SPEC-013-002 | 見出し、リスト、コードブロック、引用、リンク、強調等のパターンで Markdown と判定する |

### 保存機能 - JSON (014)

| ID | 仕様 |
|----|------|
| SPEC-014-001 | 有効な JSON を .json として UTF-8 (BOMなし) で保存する |
| SPEC-014-002 | JSON は自動整形（インデント付き）して保存する |
| SPEC-014-003 | { または [ で始まり、パース可能なテキストを JSON として認識する |

### 保存機能 - CSV (015)

| ID | 仕様 |
|----|------|
| SPEC-015-001 | タブ区切りテキスト（2行2列以上）を CSV として判定する |
| SPEC-015-002 | タブ区切りをカンマ区切りに変換して保存する |
| SPEC-015-003 | CSV は BOM 付き UTF-8 で保存し、Excel 互換とする |
| SPEC-015-004 | フィールド内のカンマ・改行・ダブルクォートを適切にエスケープする |

### コンテンツ判別 (016)

| ID | 仕様 |
|----|------|
| SPEC-016-001 | 画像が最優先で判別される |
| SPEC-016-002 | テキスト系は CSV → JSON → Markdown → テキスト の順で判別する |
| SPEC-016-003 | コンテンツ種別ごとに保存の有効/無効を設定可能 |
| SPEC-016-004 | 画像とテキストが同時に存在する場合、画像のみ保存（テキストは無視） |
| SPEC-016-005 | 空白のみのテキストは判別対象外とする |
| SPEC-016-006 | CSV/JSON/Markdown に該当しない場合はプレーンテキストとして判定する |

### 保存機能 - ファイル名命名 (017)

| ID | 仕様 |
|----|------|
| SPEC-017-001 | ファイル名プレフィックスは設定で変更可能とする |
| SPEC-017-002 | ファイル名プレフィックスの既定値は `CS` とする |
| SPEC-017-003 | ファイル名プレフィックスは保存時に 16 文字以内へ正規化する |
| SPEC-017-004 | ファイル名プレフィックスに無効文字やパス区切り文字が含まれる場合は保存時に正規化する |
| SPEC-017-005 | タイムスタンプ付与設定が ON の場合、ファイル名に `yyyyMMdd_HHmmss` を付与する |
| SPEC-017-006 | タイムスタンプ付与設定が OFF かつプレフィックスがある場合、プレフィックス基準でファイル名を生成する |
| SPEC-017-007 | タイムスタンプ付与設定が OFF かつプレフィックスが空の場合、ファイル名は連番のみ（`1`, `2`, ...）で生成する |
| SPEC-017-008 | ファイル名重複時に連番サフィックス（`_1`, `_2`, ...）を付与する（`SPEC-017-007` の連番専用モードを除く） |
| SPEC-017-009 | 予約デバイス名に一致する場合、先頭に `_` を付与する |

### ホットキー (020)

| ID | 仕様 |
|----|------|
| SPEC-020-001 | ホットキー変更が即座に反映される |
| SPEC-020-002 | 競合するホットキー設定時は登録失敗し、旧設定を維持する |
| SPEC-020-003 | キー押しっぱなしで連続発火しない |
| SPEC-020-004 | ホットキーは修飾キーを 1 つ以上必須とする |
| SPEC-020-005 | Win キーはホットキーに使用できない |
| SPEC-020-006 | 保存処理中に追加でホットキーが押下された場合は処理を開始せず無視する（`SPEC-050-006`） |

### トレイ (021)

| ID | 仕様 |
|----|------|
| SPEC-021-001 | 起動直後にトレイアイコンを表示する |
| SPEC-021-002 | トレイ右クリックメニューに「設定」「スタートアップ設定を開く」「通知設定を開く」「バージョン情報」「終了」を表示する |
| SPEC-021-003 | トレイアイコンを左クリックで設定画面を表示する |
| SPEC-021-004 | トレイ右クリックメニューから Windows スタートアップ設定を開ける |
| SPEC-021-005 | トレイ右クリックメニューから Windows 通知設定を開ける |
| SPEC-021-006 | トレイメニューから「バージョン情報」を選択で About 画面を表示する |
| SPEC-021-007 | トレイメニューから「終了」を選択でアプリケーションを終了する |
| SPEC-021-008 | トレイ右クリックメニュー表示中、アクセスキー入力で対応するメニュー項目を実行できる |
| SPEC-021-009 | 終了時にトレイアイコンを非表示・破棄する |
| SPEC-021-010 | トレイメニューは現在の UI 言語で表示する |

### エラー処理 (030)

| ID | 仕様 |
|----|------|
| SPEC-030-001 | 書き込み不可時はエラー通知（エラー通知設定が有効な場合） |
| SPEC-030-002 | 容量不足時はエラー通知（エラー通知設定が有効な場合） |
| SPEC-030-003 | クリップボードロック時はリトライ（最大 3 回、50 ms 間隔）し、失敗時は通知（エラー通知設定が有効な場合） |

### 設定 (040)

| ID | 仕様 |
|----|------|
| SPEC-040-001 | 設定変更は再起動なしで即時反映する（詳細ログ設定を除く） |
| SPEC-040-002 | 設定ファイル破損時は既定値で起動し、エラー通知設定が有効な場合は通知する |
| SPEC-040-003 | 未保存の変更がある状態で設定画面を閉じようとした場合、確認ダイアログを表示する |
| SPEC-040-004 | 設定のバリデーションエラー時、画面下部にエラーメッセージを表示する |
| SPEC-040-005 | 設定ファイル破損時は既存ファイルをバックアップする |
| SPEC-040-006 | 保存対象のコンテンツ種別は 1 つ以上有効であることを必須とする |
| SPEC-040-007 | 設定画面の保存ボタンは未保存の変更がある場合のみ有効とする |
| SPEC-040-008 | 設定画面で `Ctrl+S` は保存、`Ctrl+W` / `Escape` は閉じる操作に割り当てる |

### スタートアップ (041)

| ID | 仕様 |
|----|------|
| SPEC-041-001 | Windows のスタートアップ設定で有効な場合、サインイン時に自動起動する |
| SPEC-041-002 | 設定画面に自動起動の設定項目は表示しない（OS 側で管理） |
| SPEC-041-003 | 初回起動時に自動起動の変更方法（スタートアップ設定/設定メニュー）を通知する |
| SPEC-041-004 | インストール直後の自動起動の既定値は ON である |
| SPEC-041-005 | 初回起動の案内通知は 2 回目以降は表示しない |

### データ保存先 (042)

| ID | 仕様 |
|----|------|
| SPEC-042-001 | 非パッケージ実行時、アプリデータルートは `%APPDATA%\ClipSave` とする |
| SPEC-042-002 | MSIX パッケージ実行時、アプリデータルートは `%LOCALAPPDATA%\Packages\<PackageFamilyName>\LocalState\ClipSave` とする |
| SPEC-042-003 | 設定ファイルはアプリデータルート直下の `settings.json` に保存する |
| SPEC-042-004 | 詳細ログファイルはアプリデータルート配下の `logs` に保存する |
| SPEC-042-005 | クラッシュダンプファイルはアプリデータルート配下の `dumps` に保存する |
| SPEC-042-006 | 詳細ログ有効時、ログファイルは日次ローテーションし最新 7 ファイルを保持する |

### インストール・アンインストール (043)

| ID | 仕様 |
|----|------|
| SPEC-043-001 | MSIX 版をアンインストールした場合、アプリデータルート配下の設定・ログ・ダンプは削除される |
| SPEC-043-002 | 永続データ（設定・ログ・ダンプ）は `SPEC-042-001` / `SPEC-042-002` で定義したアプリデータルート配下に保存する |

### 通知 (050)

| ID | 仕様 |
|----|------|
| SPEC-050-001 | 通知はバルーン通知で行う |
| SPEC-050-002 | 通知全体の有効/無効は Windows 通知設定で管理し、アプリ設定には表示しない |
| SPEC-050-003 | 保存成功時の通知を設定で切り替え可能 |
| SPEC-050-004 | コンテンツなし時の通知を設定で切り替え可能 |
| SPEC-050-005 | エラー時の通知を設定で切り替え可能 |
| SPEC-050-006 | 対象外ウィンドウ・無効コンテンツ種別・保存処理中の再トリガーは通知しない（静かに無視） |
| SPEC-050-007 | 通知種別が無効な場合は該当通知を表示せずログ出力のみ行う |
| SPEC-050-008 | エラー通知は情報/警告と区別して表示する |

### About (060)

| ID | 仕様 |
|----|------|
| SPEC-060-001 | About 画面にアプリバージョン（`Versioning.md` の SSOT `Version` に対応する `X.Y.Z`）、.NET バージョン、OS バージョン、ビルド日時、著作権情報を表示する |
| SPEC-060-002 | About 画面は読み取り専用で「閉じる」ボタンで閉じる |
| SPEC-060-003 | About 画面が既に開いている場合は新規作成せず既存をアクティブ化する |
| SPEC-060-004 | About 画面に `InformationalVersion`（CI で注入されるビルド識別子）を表示する |

### クラッシュダンプ (070)

| ID | 仕様 |
|----|------|
| SPEC-070-001 | アプリが終了する未処理例外発生時にダンプファイルを出力する |
| SPEC-070-002 | ダンプ内容にタイムスタンプ・アプリ/.NET/OS 情報・例外詳細・スタックトレースを含める |
| SPEC-070-003 | 終了を伴うクラッシュ時はダンプパスをダイアログで表示する |
| SPEC-070-004 | ダンプ生成時、設定情報が取得可能な場合は `[Settings Snapshot]` セクションとして設定スナップショットを含める |

### 終了機能 (080)

| ID | 仕様 |
|----|------|
| SPEC-080-001 | 終了時に全サービスを適切に Dispose する |
| SPEC-080-002 | 終了時にグローバルホットキーを解除する |
| SPEC-080-003 | 終了時に多重起動防止用ミューテックスを解放する |
| SPEC-080-004 | 終了時に Named Pipe サーバーを停止する |
| SPEC-080-005 | 終了時にすべてのウィンドウを閉じる |
| SPEC-080-006 | 多重起動防止でミューテックス取得失敗時は即時終了（クリーンアップ不要） |
| SPEC-080-007 | 起動エラー時は適切にクリーンアップして終了する |

### ローカライズ (090)

| ID | 仕様 |
|----|------|
| SPEC-090-001 | UI 言語は英語（`en`）/ 日本語（`ja`）の 2 種のみサポートする |
| SPEC-090-002 | UI 言語未設定時、システム言語が日本語なら日本語、それ以外は英語を適用する |
| SPEC-090-003 | UI 言語設定が無効値の場合は英語へフォールバックする |
| SPEC-090-004 | 設定画面で UI 言語（英語 / 日本語）を変更可能とする |
| SPEC-090-005 | UI とバルーン通知は現在の UI 言語で表示する |
| SPEC-090-006 | UI 言語変更は設定保存後に再起動なしで反映する |
| SPEC-090-007 | 設定画面表示時は、起動経路（通常起動 / 既存インスタンス起動中の再起動要求）にかかわらず、現在の UI 言語設定を再適用して表示する |
| SPEC-090-008 | UI 言語は `en` / `ja` 系のみ有効。その他は英語にフォールバックする |

## 関連ドキュメント

- [使い方ガイド](../UsageGuide.md) - 基本操作と設定
- [製品コンセプト](../ProductConcept.md) - ビジョンと設計思想
- [アーキテクチャ](Architecture.md) - システムアーキテクチャ
- [テスト戦略](TestingStrategy.md) - テスト方針
